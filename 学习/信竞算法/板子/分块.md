---
tags:
  - 板子
---
# 区间加
[例题](http://ssloj.cn/contest/262/problem/6)
```cpp
#include<bits/stdc++.h>
#define rep(u,x,y) for(int u=x;u<=y;++u)
using namespace std;
typedef long long ll;
const int N=1e6+1,M=501;
ll sum[M],tag[M],id[N],len,sid,eid;
ll a[N],n,m,op,x,y,z,res;
void upd(int l,int r,int d){
    sid=id[l],eid=id[r];
    if(sid==eid)rep(i,l,r)a[i]+=d,sum[sid]+=d;
    else{
        rep(i,sid+1,eid-1)sum[i]+=len*d,tag[i]+=d;
        for(int i=l;id[i]==sid;++i)a[i]+=d,sum[sid]+=d;
        for(int i=r;id[i]==eid;--i)a[i]+=d,sum[eid]+=d;
    }
}
ll ask(int l,int r){
    sid=id[l],eid=id[r],res=0;
    if(sid==eid)rep(i,l,r)res+=a[i]+tag[sid];
    else{
        rep(i,sid+1,eid-1)res+=sum[i];
        for(int i=l;id[i]==sid;++i)res+=a[i]+tag[sid];
        for(int i=r;id[i]==eid;--i)res+=a[i]+tag[eid];
    }
    return res;
}
int main(){
    cin>>n>>m;
    len=sqrt(n);
    rep(i,1,n)cin>>a[i],sum[id[i]=(i-1)/len+1]+=a[i];
    while(m--){
        cin>>op>>x>>y;
        if(op==1)cin>>z,upd(x,y,z);
        else cout<<ask(x,y)<<endl;
    }
    return 0;
}
```

# 区间加乘 (很慢)
[例题](https://www.luogu.com.cn/problem/P3373)
```cpp
#include<bits/stdc++.h>
#define rep(u,x,y) for(int u=x;u<=y;++u)
#define pos(x) ((x-1)/len+1)
#define gc getchar
#define pc putchar
using namespace std;
typedef long long ll;
const int N=1e5+1,mod=571373;
ll sum[N],add[N],mul[N],id[N],len,sid,eid,fff,lst,pa[N],num;
ll a[N],n,m,op,x,y,res;
ll read(){
    ll x=0,f=1;
    char ch=gc();
    while(ch<'0'||ch>'9')ch=='-'&&(f=-1,0),ch=gc();
    while(ch>='0'&&ch<='9')x=(x*10)+(ch^48),ch=gc();
    return x*f;
}
void wrt(ll x){
    if(x<0)x=-x,pc('-');
    if(x>9)wrt(x/10);
    pc(x%10^48);
}
void pushdown(int p){
    if(!add[p]&&mul[p]==1)return;
    sum[p]=0;
    rep(i,pa[p],min(pa[p+1]-1,n))a[i]=(a[i]*mul[p]+add[p])%mod,sum[p]=(sum[p]+a[i])%mod;
    add[p]=0,mul[p]=1;
}
void updadd(int l,int r,ll d){
    sid=id[l],eid=id[r];
    if(sid==eid){
        pushdown(sid);
        rep(i,l,r)a[i]=(a[i]+d)%mod,sum[sid]=(sum[sid]+d)%mod;
    }else{
        rep(i,sid+1,eid-1)add[i]=(add[i]+d)%mod,sum[i]=(sum[i]+len*d)%mod;
        pushdown(sid),pushdown(eid);
        for(int i=l;id[i]==sid;++i)a[i]=(a[i]+d)%mod,sum[sid]=(sum[sid]+d)%mod;
        for(int i=r;id[i]==eid;--i)a[i]=(a[i]+d)%mod,sum[eid]=(sum[eid]+d)%mod;
    }
}
void updmul(int l,int r,ll d){
    sid=id[l],eid=id[r];
    if(sid==eid){
        pushdown(sid);
        rep(i,l,r)lst=a[i],a[i]=(a[i]*d)%mod,sum[sid]=(sum[sid]+a[i]-lst+mod)%mod;
    }else{
        rep(i,sid+1,eid-1)add[i]=(add[i]*d)%mod,mul[i]=(mul[i]*d)%mod,sum[i]=(sum[i]*d)%mod;
        pushdown(sid),pushdown(eid);
        for(int i=l;id[i]==sid;++i)lst=a[i],a[i]=(a[i]*d)%mod,sum[sid]=(sum[sid]+a[i]-lst+mod)%mod;
        for(int i=r;id[i]==eid;--i)lst=a[i],a[i]=(a[i]*d)%mod,sum[eid]=(sum[eid]+a[i]-lst+mod)%mod;
    }
}
ll ask(int l,int r){
    sid=id[l],eid=id[r],res=0;
    if(sid==eid){
        pushdown(sid);
        rep(i,l,r)res=(res+a[i])%mod;
    }else{
        rep(i,sid+1,eid-1)res=(res+sum[i])%mod;
        pushdown(sid),pushdown(eid);
        for(int i=l;id[i]==sid;++i)res=(res+a[i])%mod;
        for(int i=r;id[i]==eid;--i)res=(res+a[i])%mod;
    }
    return res;
}
int main(){
    n=read(),m=read(),fff=read(),len=sqrt(n),num=n/len;
    rep(i,1,n)a[i]=read(),sum[id[i]=pos(i)]+=a[i];
    rep(i,1,num+10)pa[i]=((i-1)*len+1),mul[i]=1;
    while(m--){
        op=read(),x=read(),y=read();
        if(op==1)updmul(x,y,read());
        else if(op==2)updadd(x,y,read());
        else wrt(ask(x,y)),pc('\n');
    }
    return 0;
}
```